<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Frostsnap Workshop - Web Tools</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <div class="container">
      <div class="logo-box">
        <a href="/">
          <img
            src="https://frostsnap.com/assets/frostsnap-logo.svg"
            alt="Frostsnap Logo"
            class="logo"
          />
        </a>
      </div>
      <h1><a href="/">Frostsnap BTC++ Workshop</a></h1>
      <div class="subtitle">
        Distributed Key Generation & Threshold Signing Coordination
      </div>
      <div class="header-links">
        <b
          ><a href="https://github.com/nickfarrow/yushan" target="_blank"
            >Get the CLI tool</a
          >
        </b>
        <a href="/cli.html"
          >Im allergic to crustaceans ðŸ¦€ (use browser tools)</a
        >
      </div>
      <br />

      <!-- Config Section -->
      <div class="config-section">
        <div class="config-header">
          <span class="status-indicator" id="status-indicator"></span>
          <span>Configuration</span>
          <span id="status-text" style="margin-left: auto; font-size: 0.8em"
            >Disconnected</span
          >
        </div>

        <div class="config-grid">
          <div class="config-field">
            <label>Room ID</label>
            <input
              type="text"
              id="room-id"
              placeholder="e.g., table-1, my-frost-session"
              value="stayfrosty"
            />
          </div>
          <div class="config-field">
            <label>Threshold (t)</label>
            <input
              type="number"
              id="threshold"
              placeholder="Minimum signers"
              value="2"
              min="1"
            />
          </div>
          <div class="config-field">
            <label>Total Parties (n)</label>
            <input
              type="number"
              id="n-parties"
              placeholder="Total participants"
              value="3"
              min="1"
            />
          </div>
        </div>

        <button class="btn" onclick="updateConfig()">Update & Subscribe</button>
        <button
          class="btn btn-secondary"
          onclick="clearAll()"
          style="margin-left: 10px"
        >
          Clear All Data
        </button>
      </div>

      <div class="warning">
        âš  Everyone must agree on the same threshold and n_parties values for the
        protocol to work!
      </div>

      <h1>Distributed Key Generation</h1>

      <!-- Keygen Round 1 -->
      <div class="phase-section">
        <div class="phase-header">
          <div class="phase-title">Distributed Keygen Round 1: Commitments</div>
          <div class="phase-count" id="round1-count">0 / 0</div>
        </div>

        <div class="post-box">
          <div class="post-label">
            Run: <code>cargo run -- keygen-round1 --threshold 2 --n-parties 3 --my-index &lt;your-index&gt;</code>
          </div>
          <textarea
            class="post-textarea"
            id="round1-input"
            placeholder='Paste your keygen-round1 JSON output here, e.g.: {"party_index": 1, "keygen_input": "hex...", "type": "keygen_round1"}'
          ></textarea>
          <button
            class="btn"
            onclick="postToNostr('round1-input', 'keygen_round1')"
          >
            Broadcast
          </button>
        </div>

        <div class="entries-container" id="round1-entries">
          <div class="empty-state">
            Waiting for parties to post their commitments...
          </div>
        </div>
        <div class="copy-section" id="round1-copy-section">
          <div class="copy-label">Aggregated Commitments</div>
          <div class="copy-output" id="round1-output">No data yet</div>
          <button
            class="btn btn-secondary"
            onclick="copyToClipboard('round1-output')"
          >
            Copy All
          </button>
        </div>
      </div>

      <!-- Keygen Round 2 -->
      <div class="phase-section">
        <div class="phase-header">
          <div class="phase-title">
            Distributed Keygen Round 2: Keygen Shares
          </div>
          <div class="phase-count" id="round2-count">0 / 0</div>
        </div>

        <div class="post-box">
          <div class="post-label">
            Run: <code>cargo run -- keygen-round2 --my-index &lt;your-index&gt; --data '&lt;all-commitments&gt;'</code>
          </div>
          <textarea
            class="post-textarea"
            id="round2-input"
            placeholder='Paste your keygen-round2 JSON output here, e.g.: {"party_index": 1, "shares": [...], "type": "keygen_round2"}'
          ></textarea>
          <button
            class="btn"
            onclick="postToNostr('round2-input', 'keygen_round2')"
          >
            Broadcast
          </button>
        </div>

        <div class="entries-container" id="round2-entries">
          <div class="empty-state">
            Waiting for parties to post their secret shares...
          </div>
        </div>
        <div class="copy-section" id="round2-copy-section">
          <div class="copy-label">Aggregated Shares</div>
          <div class="copy-output" id="round2-output">No data yet</div>
          <button
            class="btn btn-secondary"
            onclick="copyToClipboard('round2-output')"
          >
            Copy All
          </button>
        </div>
      </div>

      <h1>Signing</h1>

      <!-- Signing Nonces -->
      <div class="phase-section">
        <div class="phase-header">
          <div class="phase-title">Signing: Nonces</div>
          <div class="phase-count" id="nonce-count">0 / 0</div>
        </div>

        <div class="post-box">
          <div class="post-label">
            Run: <code>cargo run -- sign-nonce --session "msg1"</code>
          </div>
          <textarea
            class="post-textarea"
            id="nonce-input"
            placeholder='Paste your sign-nonce JSON output here, e.g.: {"party_index": 1, "session": "msg1", "nonce": "hex...", "type": "signing_nonce"}'
          ></textarea>
          <button
            class="btn"
            onclick="postToNostr('nonce-input', 'signing_nonce')"
          >
            Broadcast
          </button>
        </div>

        <div class="entries-container" id="nonce-entries">
          <div class="empty-state">Waiting for signers to post nonces...</div>
        </div>
        <div class="copy-section" id="nonce-copy-section">
          <div class="copy-label">Aggregated Nonces</div>
          <div class="copy-output" id="nonce-output">No data yet</div>
          <button
            class="btn btn-secondary"
            onclick="copyToClipboard('nonce-output')"
          >
            Copy All
          </button>
        </div>
      </div>

      <!-- Signing Shares -->
      <div class="phase-section">
        <div class="phase-header">
          <div class="phase-title">Signing: Signature Shares</div>
          <div class="phase-count" id="sig-count">0 / 0</div>
        </div>

        <div class="post-box">
          <div class="post-label">
            Run: <code>cargo run -- sign --session "msg1" --message "Hello!" --data '&lt;all-nonces&gt;'</code>
          </div>
          <textarea
            class="post-textarea"
            id="sig-input"
            placeholder='Paste your sign JSON output here, e.g.: {"party_index": 1, "session": "msg1", "signature_share": "hex...", "type": "signing_share"}'
          ></textarea>
          <button
            class="btn"
            onclick="postToNostr('sig-input', 'signing_share')"
          >
            Broadcast
          </button>
        </div>

        <div class="entries-container" id="sig-entries">
          <div class="empty-state">
            Waiting for signers to post signature shares...
          </div>
        </div>
        <div class="copy-section" id="sig-copy-section">
          <div class="copy-label">Aggregated Signature Shares</div>
          <div class="copy-output" id="sig-output">No data yet</div>
          <button
            class="btn btn-secondary"
            onclick="copyToClipboard('sig-output')"
          >
            Copy All
          </button>
        </div>
      </div>

      <!-- Signature Verifier -->
      <h1>Signature Verifier</h1>
      <div class="phase-section">
        <div class="phase-header">
          <div class="phase-title">Verify Schnorr Signature</div>
        </div>

        <div class="post-box">
          <div class="post-label">Signature (hex)</div>
          <textarea
            class="post-textarea"
            id="verify-signature"
            placeholder="Paste signature hex here..."
          ></textarea>
        </div>

        <div class="post-box">
          <div class="post-label">Public Key (hex)</div>
          <textarea
            class="post-textarea"
            id="verify-pubkey"
            placeholder="Paste public key hex here..."
          ></textarea>
        </div>

        <div class="post-box">
          <div class="post-label">Message</div>
          <input
            type="text"
            id="verify-message"
            placeholder="The message that was signed..."
            style="
              width: 100%;
              padding: 10px;
              background: var(--bg-primary);
              border: 1px solid var(--secondary);
              color: var(--primary);
              border-radius: 15px;
            "
          />
        </div>

        <button class="btn" onclick="verifySignature()">
          Verify Signature
        </button>

        <div
          id="verify-output"
          class="entries-container"
          style="margin-top: 20px; display: none"
        >
          <div class="entry" id="verify-result"></div>
        </div>
      </div>

      <div class="footer-logo">
        <img
          src="https://frostsnap.com/assets/small-stay-frosty.svg"
          alt="Stay Frosty"
        />
      </div>
    </div>

    <script type="module">
      import {
        SimplePool,
        generateSecretKey,
        getPublicKey,
        finalizeEvent,
      } from "https://esm.sh/nostr-tools@2.7.2";

      import init, { wasm_verify } from "./pkg/yushan.js";

      const RELAYS = [
        "wss://relay.damus.io",
        "wss://nos.lol",
        "wss://relay.nostr.band",
      ];

      let pool = new SimplePool();
      let currentSub = null;
      let currentRoom = null;
      let connected = false;

      // Generate ephemeral keypair for signing Nostr events
      const sk = generateSecretKey();
      const pk = getPublicKey(sk);

      // Data storage: phase -> party_index -> event
      const phaseData = {
        keygen_round1: new Map(),
        keygen_round2: new Map(),
        signing_nonce: new Map(),
        signing_share: new Map(),
      };

      // Subscribe to Nostr events for the current room
      window.updateConfig = function () {
        const roomId = document.getElementById("room-id").value.trim();
        const threshold = parseInt(document.getElementById("threshold").value);
        const nParties = parseInt(document.getElementById("n-parties").value);

        if (!roomId) {
          alert("Please enter a room ID");
          return;
        }

        if (threshold < 1 || nParties < 1 || threshold > nParties) {
          alert("Invalid threshold or n_parties values");
          return;
        }

        // Reset connection status
        connected = false;
        document
          .getElementById("status-indicator")
          .classList.remove("connected");
        document.getElementById("status-text").textContent = "Disconnected";
        document.getElementById("status-text").style.color = "";

        // Unsubscribe from previous room
        if (currentSub) {
          currentSub.close();
        }

        // Clear previous data
        phaseData.keygen_round1.clear();
        phaseData.keygen_round2.clear();
        phaseData.signing_nonce.clear();
        phaseData.signing_share.clear();

        currentRoom = roomId;

        // Subscribe to new room
        console.log(`Subscribing to room: ${roomId}`);

        currentSub = pool.subscribeMany(
          RELAYS,
          [
            {
              kinds: [1],
              "#r": [roomId],
              since: Math.floor(Date.now() / 1000) - 3600, // Last hour
            },
          ],
          {
            onevent(event) {
              try {
                const data = JSON.parse(event.content);
                processEvent(data, event);
              } catch (e) {
                console.error("Failed to parse event:", e);
              }
            },
            oneose() {
              console.log("Initial sync complete");
            },
          }
        );

        // Update status to connected immediately after subscribing
        connected = true;
        document.getElementById("status-indicator").classList.add("connected");
        document.getElementById("status-text").textContent = "Connected";
        document.getElementById("status-text").style.color = "#01b3b9e9";

        refreshUI();
      };

      function processEvent(data, nostrEvent) {
        const eventType = data.type;
        const partyIndex = data.party_index;

        if (!phaseData[eventType]) {
          console.warn("Unknown event type:", eventType);
          return;
        }

        // Deduplication: Keep earliest event for each party in each phase
        const existing = phaseData[eventType].get(partyIndex);
        if (existing && existing.created_at <= nostrEvent.created_at) {
          return; // Already have an earlier event
        }

        phaseData[eventType].set(partyIndex, {
          ...data,
          created_at: nostrEvent.created_at,
          nostr_id: nostrEvent.id,
        });

        refreshUI();
      }

      function refreshUI() {
        const threshold = parseInt(document.getElementById("threshold").value);
        const nParties = parseInt(document.getElementById("n-parties").value);

        updatePhaseUI("keygen_round1", "round1", nParties);
        updatePhaseUI("keygen_round2", "round2", nParties);
        updatePhaseUI("signing_nonce", "nonce", threshold);
        updatePhaseUI("signing_share", "sig", threshold);
      }

      function updatePhaseUI(phaseKey, uiPrefix, expectedCount) {
        const data = phaseData[phaseKey];
        const entriesEl = document.getElementById(`${uiPrefix}-entries`);
        const countEl = document.getElementById(`${uiPrefix}-count`);
        const outputEl = document.getElementById(`${uiPrefix}-output`);
        const copySectionEl = document.getElementById(
          `${uiPrefix}-copy-section`
        );

        // Update count
        countEl.textContent = `${data.size} / ${expectedCount}`;

        // Update count color based on completion
        if (data.size >= expectedCount) {
          countEl.style.color = "var(--secondary)";
          countEl.style.fontWeight = "bold";
        } else {
          countEl.style.color = "var(--primary)";
          countEl.style.fontWeight = "normal";
        }

        // Update entries display
        if (data.size === 0) {
          entriesEl.innerHTML = '<div class="empty-state">No data yet...</div>';
        } else {
          entriesEl.innerHTML = "";
          const sortedEntries = Array.from(data.values()).sort(
            (a, b) => a.party_index - b.party_index
          );

          sortedEntries.forEach((entry) => {
            const entryDiv = document.createElement("div");
            entryDiv.className = "entry";

            const date = new Date(entry.created_at * 1000);
            const timeStr = date.toLocaleTimeString();

            entryDiv.innerHTML = `
              <div class="entry-header">
                <span class="entry-party">Party ${entry.party_index}</span>
                <span class="entry-time">${timeStr}</span>
              </div>
              <div class="entry-data">${JSON.stringify(entry, null, 2)}</div>
            `;

            entriesEl.appendChild(entryDiv);
          });
        }

        // Show/hide and update aggregated output section based on whether we have enough data
        if (data.size >= expectedCount) {
          copySectionEl.style.display = "block";
          const jsonObjects = Array.from(data.values())
            .sort((a, b) => a.party_index - b.party_index)
            .map((entry) => {
              // Remove our metadata before outputting
              const clean = { ...entry };
              delete clean.created_at;
              delete clean.nostr_id;
              return JSON.stringify(clean);
            });

          outputEl.textContent = jsonObjects.join(" ");
        } else {
          copySectionEl.style.display = "none";
        }
      }

      window.copyToClipboard = function (elementId) {
        const el = document.getElementById(elementId);
        const text = el.textContent;

        if (text === "No data yet") {
          alert("No data to copy");
          return;
        }

        navigator.clipboard.writeText(text).then(
          () => {
            // Visual feedback
            const originalBg = el.style.background;
            el.style.background = "#1a3a1a";
            setTimeout(() => {
              el.style.background = originalBg;
            }, 200);
          },
          (err) => {
            console.error("Failed to copy:", err);
            alert("Failed to copy to clipboard");
          }
        );
      };

      window.clearAll = function () {
        if (
          !confirm("Clear all data for this session? This cannot be undone.")
        ) {
          return;
        }

        phaseData.keygen_round1.clear();
        phaseData.keygen_round2.clear();
        phaseData.signing_nonce.clear();
        phaseData.signing_share.clear();

        refreshUI();
      };

      window.postToNostr = async function (textareaId, expectedType) {
        const textarea = document.getElementById(textareaId);
        const content = textarea.value.trim();

        if (!content) {
          alert("Please paste your CLI output first");
          return;
        }

        if (!currentRoom) {
          alert("Please configure and subscribe to a room first");
          return;
        }

        // Validate JSON
        let data;
        try {
          data = JSON.parse(content);
        } catch (e) {
          alert(
            "Invalid JSON. Please paste the output from your CLI exactly as shown."
          );
          return;
        }

        // Validate type matches
        if (data.type !== expectedType) {
          alert(
            `Expected type "${expectedType}" but got "${data.type}". Make sure you're pasting the correct CLI output.`
          );
          return;
        }

        // Validate required fields
        if (!data.party_index) {
          alert("Missing party_index in JSON");
          return;
        }

        // Create and publish Nostr event
        try {
          const event = finalizeEvent(
            {
              kind: 1,
              created_at: Math.floor(Date.now() / 1000),
              tags: [["r", currentRoom]],
              content: content,
            },
            sk
          );

          await Promise.any(pool.publish(RELAYS, event));

          // Clear textarea and show success
          textarea.value = "";
          textarea.style.borderColor = "#01b3b9e9";
          setTimeout(() => {
            textarea.style.borderColor = "#01b3b9e9";
          }, 500);

          console.log("Published event:", event.id);
        } catch (e) {
          console.error("Failed to publish:", e);
          alert(
            "Failed to publish to Nostr relays. Check console for details."
          );
        }
      };

      // Signature verification
      let wasmInitialized = false;

      async function initWasm() {
        if (!wasmInitialized) {
          try {
            await init();
            wasmInitialized = true;
            console.log("WASM loaded for signature verification");
          } catch (e) {
            console.error("Failed to load WASM:", e);
          }
        }
      }

      window.verifySignature = async function () {
        const signature = document
          .getElementById("verify-signature")
          .value.trim();
        const pubkey = document.getElementById("verify-pubkey").value.trim();
        const message = document.getElementById("verify-message").value.trim();

        if (!signature || !pubkey || !message) {
          alert("Please fill in all fields");
          return;
        }

        // Initialize WASM if needed
        await initWasm();

        try {
          const resultJson = wasm_verify(signature, pubkey, message);
          const result = JSON.parse(resultJson);

          const outputDiv = document.getElementById("verify-output");
          const resultDiv = document.getElementById("verify-result");

          const isValid = result.result === "VALID";
          resultDiv.innerHTML = `
            <div style="white-space: pre-wrap; font-family: Monaco, monospace; ${
              isValid ? "color: #00ff00;" : "color: #ff6b6b;"
            }">
              ${result.output}
            </div>
          `;
          outputDiv.style.display = "block";
        } catch (e) {
          alert("Verification error: " + e);
          console.error("Verification error:", e);
        }
      };

      // Auto-connect on load with default values
      window.addEventListener("load", () => {
        updateConfig();
        initWasm(); // Pre-load WASM for verifier
      });
    </script>
  </body>
</html>
